    <mat-card *ngIf="bom(); else loadingTpl">
      <mat-card-title>
        <div class="pt-row" style="gap: 12px; align-items:center; flex-wrap: wrap">
          <span>BOM  -  #{{ bom()!.id }}</span>
          <mat-chip>{{ bom()!.status }}</mat-chip>
          <span style="flex: 1 1 auto"></span>
          <a mat-button color="primary" [routerLink]="['/boms', bom()!.id, 'events']">Events</a>
          <button mat-stroked-button color="primary" [matMenuTriggerFor]="downloadMenu">
            <mat-icon>download</mat-icon>
            Download
          </button>
        </div>
      </mat-card-title>
      <mat-card-content>
        <form [formGroup]="metaForm" (ngSubmit)="saveMeta()" class="pt-grid">
          <mat-form-field appearance="outline">
            <mat-label>Title</mat-label>
            <input matInput formControlName="title" [readonly]="!editable()" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Project</mat-label>
            <input matInput formControlName="project" [readonly]="!editable()" />
          </mat-form-field>
          <div class="pt-row" style="gap: 10px; align-items:center; flex-wrap: wrap">
            <span class="pt-muted">Updated {{ bom()!.updated_at | date: 'medium' }}</span>
            <span style="flex: 1 1 auto"></span>
            <button mat-raised-button color="primary" type="submit" [disabled]="!editable() || savingMeta">
              <mat-icon>save</mat-icon>
              Save
            </button>
            <button mat-stroked-button color="primary" type="button" (click)="reload()">
              <mat-icon>refresh</mat-icon>
              Reload
            </button>
          </div>
        </form>

        <div class="pt-section">
          <div class="pt-row" style="align-items:center; gap: 10px">
            <div class="pt-h">Collaborators</div>
            <span class="pt-muted">Collaborators can edit and request approvals.</span>
          </div>

          <div class="pt-grid" style="margin-top: 12px">
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Add collaborator</mat-label>
              <mat-select [formControl]="collabForm.controls.user_id" [disabled]="!canManageCollaborators()">
                <mat-option *ngFor="let u of availableCollaborators()" [value]="u.id">{{ displayUser(u) }}</mat-option>
              </mat-select>
            </mat-form-field>
            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-raised-button color="primary" type="button" (click)="addCollaborator()" [disabled]="!canManageCollaborators() || !collabForm.controls.user_id.value">
                Add collaborator
              </button>
              <span class="pt-muted" *ngIf="!canManageCollaborators()">Only the owner or procurement/admin can add/remove.</span>
            </div>
          </div>

          <div class="pt-row" style="gap:12px; align-items:center; margin-top: 12px" *ngIf="loadingCollaborators()">
            <span>No data available</span>
          </div>

          <div class="pt-muted" *ngIf="!loadingCollaborators() && collaborators().length === 0" style="margin-top: 8px">
            No collaborators yet.
          </div>

          <div class="pt-collab-list" *ngIf="!loadingCollaborators() && collaborators().length">
            <div class="pt-collab" *ngFor="let c of collaborators()">
              <div>
                <div class="pt-title">{{ displayName(c) }}</div>
                <div class="pt-muted" *ngIf="displayName(c) !== c.email">{{ c.email }}</div>
              </div>
              <span style="flex: 1 1 auto"></span>
              <button mat-stroked-button color="primary" type="button" (click)="removeCollaborator(c.id)" [disabled]="!canRemoveCollaborator(c.id)">
                Remove
              </button>
            </div>
          </div>
        </div>

        <div class="pt-section">
          <div class="pt-row" style="align-items:center; gap: 10px">
            <div class="pt-h">Items</div>
            <span class="pt-muted">{{ bom()!.items.length }} items</span>
            <span style="flex: 1 1 auto"></span>
            <button mat-raised-button color="primary" type="button" (click)="showAddItem = !showAddItem" [disabled]="!editable()">
              <mat-icon>add</mat-icon>
              Add item
            </button>
          </div>

          <form *ngIf="showAddItem" [formGroup]="itemForm" (ngSubmit)="addItem()" class="pt-grid" style="margin-top: 12px">
            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-stroked-button color="primary" type="button" (click)="openCatalogPicker()" [disabled]="!editable()">
                <mat-icon>library_add</mat-icon>
                Select from Catalog
              </button>
              <div class="pt-muted" *ngIf="selectedCatalog()">
                Using: <span class="pt-title">{{ selectedCatalog()!.name }}</span>
                <a *ngIf="selectedCatalog()!.vendor_url" class="pt-link" [href]="selectedCatalog()!.vendor_url" target="_blank" rel="noopener">
                  Vendor link
                </a>
                <button mat-button type="button" (click)="clearCatalogSelection()">Clear</button>
              </div>
            </div>
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Name</mat-label>
              <input matInput formControlName="name" />
            </mat-form-field>
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="2"></textarea>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Quantity</mat-label>
              <input matInput formControlName="quantity" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Unit</mat-label>
              <input matInput formControlName="unit" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Vendor</mat-label>
              <input matInput formControlName="vendor" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Category</mat-label>
              <input matInput formControlName="category" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Unit price</mat-label>
              <input matInput formControlName="unit_price" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Currency</mat-label>
              <input matInput formControlName="currency" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Tax %</mat-label>
              <input matInput formControlName="tax_percent" />
            </mat-form-field>
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Link</mat-label>
              <input matInput formControlName="link" />
            </mat-form-field>
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Notes</mat-label>
              <textarea matInput formControlName="notes" rows="3"></textarea>
            </mat-form-field>

            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-raised-button color="primary" type="submit" [disabled]="itemForm.invalid || savingItem">
                <mat-icon>add</mat-icon>
                Add
              </button>
              <button mat-button type="button" (click)="showAddItem = false">Cancel</button>
            </div>
          </form>

          <table mat-table [dataSource]="bom()!.items" class="pt-table" style="margin-top: 14px">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let i">
                <div class="pt-title">{{ i.name }}</div>
                <div class="pt-muted" *ngIf="i.vendor">{{ i.vendor }}</div>
                <div class="pt-muted" *ngIf="i.category">{{ i.category }}</div>
              </td>
            </ng-container>
            <ng-container matColumnDef="qty">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let i">{{ i.quantity }} {{ i.unit }}</td>
            </ng-container>
            <ng-container matColumnDef="signoff">
              <th mat-header-cell *matHeaderCellDef>Signoff</th>
              <td mat-cell *matCellDef="let i">
                <mat-chip>{{ i.signoff_status }}</mat-chip>
              </td>
            </ng-container>
            <ng-container matColumnDef="received">
              <th mat-header-cell *matHeaderCellDef>Received</th>
              <td mat-cell *matCellDef="let i">{{ i.received_quantity }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="itemColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: itemColumns"></tr>
          </table>
        </div>

        <div class="pt-section" data-tutorial="bom-workflow">
          <div class="pt-h">Workflow</div>

          <div class="pt-grid" style="margin-top: 12px">
            <mat-form-field appearance="outline">
              <mat-label>Signoff assignee</mat-label>
              <mat-select [formControl]="signoffForm.controls.assignee_id" [disabled]="!canRequestWorkflow()">
                <mat-option *ngFor="let u of users" [value]="u.id">{{ displayUser(u) }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Items (optional)</mat-label>
              <mat-select [formControl]="signoffForm.controls.item_ids" multiple [disabled]="!canRequestWorkflow()">
                <mat-option *ngFor="let i of bom()!.items" [value]="i.id">{{ i.name }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Signoff comment</mat-label>
              <textarea matInput [formControl]="signoffForm.controls.comment" rows="2" [disabled]="!canRequestWorkflow()"></textarea>
            </mat-form-field>

            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-raised-button color="primary" type="button" (click)="requestSignoff()" [disabled]="!canRequestWorkflow() || savingSignoff">
                Request signoff
              </button>
              <span class="pt-muted">Owner or collaborator can request signoff.</span>
            </div>
          </div>

          <div class="pt-grid" style="margin-top: 18px">
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Procurement approvers</mat-label>
              <mat-select [formControl]="approvalForm.controls.approver_ids" multiple [disabled]="!canRequestWorkflow()">
                <mat-option *ngFor="let u of approvers()" [value]="u.id">{{ displayUser(u) }}</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Approval comment</mat-label>
              <textarea matInput [formControl]="approvalForm.controls.comment" rows="2" [disabled]="!canRequestWorkflow()"></textarea>
            </mat-form-field>
            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="requestApproval()"
                [disabled]="!canRequestWorkflow() || savingApproval || !approvalForm.controls.approver_ids.value?.length"
              >
                Request procurement approval
              </button>
              <span class="pt-muted">Owner or collaborator can request approval.</span>
            </div>
          </div>

          <div class="pt-grid" style="margin-top: 18px">
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Cancel comment (optional)</mat-label>
              <textarea matInput [formControl]="cancelForm.controls.comment" rows="2"></textarea>
            </mat-form-field>
            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-stroked-button color="primary" type="button" (click)="cancelFlow()" [disabled]="savingCancel || !canCancelFlow()">
                Cancel flow (back to draft)
              </button>
              <span class="pt-muted">Only the BOM owner or procurement can cancel.</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-menu #downloadMenu="matMenu">
      <button mat-menu-item type="button" (click)="download('pdf')">PDF</button>
      <button mat-menu-item type="button" (click)="download('csv')">CSV</button>
      <button mat-menu-item type="button" (click)="download('json')">JSON</button>
    </mat-menu>

    <ng-template #loadingTpl>
      <mat-card>
        <mat-card-content>
          <div class="pt-row" style="gap:12px; align-items:center">
            
            <span>No data available</span>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-template>
  

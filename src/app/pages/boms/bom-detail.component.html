    <mat-card *ngIf="bom(); else loadingTpl">
      <mat-card-title>
        <div class="pt-row" style="gap: 12px; align-items:center; flex-wrap: wrap">
          <span>BOM  -  #{{ bom()!.id }}</span>
          <mat-chip>{{ bom()!.status }}</mat-chip>
          <span style="flex: 1 1 auto"></span>
          <a mat-button color="primary" [routerLink]="['/boms', bom()!.id, 'events']">Events</a>
          <button mat-stroked-button color="primary" type="button" (click)="deleteBom()" [disabled]="!canDeleteBom() || deletingBom">
            <mat-icon>delete</mat-icon>
            Delete
          </button>
          <button mat-stroked-button color="primary" [matMenuTriggerFor]="downloadMenu">
            <mat-icon>download</mat-icon>
            Download
          </button>
        </div>
      </mat-card-title>
      <mat-card-content>
        <form [formGroup]="metaForm" (ngSubmit)="saveMeta()" class="pt-meta">
          <div class="pt-meta-row">
            <mat-form-field appearance="outline" class="pt-meta-field">
              <mat-label>Title</mat-label>
              <input matInput formControlName="title" [readonly]="!editable()" />
            </mat-form-field>
            <mat-form-field appearance="outline" class="pt-meta-field">
              <mat-label>Project</mat-label>
              <input matInput formControlName="project" [readonly]="!editable()" />
            </mat-form-field>
            <button
              mat-icon-button
              color="primary"
              type="submit"
              [disabled]="!editable() || savingMeta"
              matTooltip="Save"
            >
              <mat-icon>save</mat-icon>
            </button>
            <button mat-icon-button color="primary" type="button" (click)="reload()" matTooltip="Reload">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
          <div class="pt-meta-sub">
            <span class="pt-muted">Updated {{ bom()!.updated_at | date: 'medium' }}</span>
          </div>
        </form>

        <div class="pt-section">
          <div class="pt-row" style="align-items:center; gap: 10px; flex-wrap: wrap">
            <div class="pt-h">Collaborators</div>
            <span class="pt-muted">Collaborators can edit and request approvals.</span>
            <span style="flex: 1 1 auto"></span>
            <button
              mat-icon-button
              color="primary"
              type="button"
              matTooltip="Add collaborator"
              (click)="openCollaboratorDialog()"
              [disabled]="!canManageCollaborators()"
            >
              <mat-icon>person_add</mat-icon>
            </button>
          </div>

          <div class="pt-row" style="gap:12px; align-items:center; margin-top: 12px" *ngIf="loadingCollaborators()">
            <span>No data available</span>
          </div>

          <div class="pt-muted" *ngIf="!loadingCollaborators() && collaborators().length === 0" style="margin-top: 8px">
            No collaborators yet.
          </div>

          <div class="pt-collab-list" *ngIf="!loadingCollaborators() && collaborators().length">
            <div class="pt-collab" *ngFor="let c of collaborators()">
              <div>
                <div class="pt-title">{{ displayName(c) }}</div>
                <div class="pt-muted" *ngIf="displayName(c) !== c.email">{{ c.email }}</div>
              </div>
              <span style="flex: 1 1 auto"></span>
              <button mat-stroked-button color="primary" type="button" (click)="removeCollaborator(c.id)" [disabled]="!canRemoveCollaborator(c.id)">
                Remove
              </button>
            </div>
          </div>
        </div>

        <div class="pt-section">
          <div class="pt-row" style="align-items:center; gap: 10px">
            <div class="pt-h">Items</div>
            <span class="pt-muted">{{ bom()!.items.length }} items</span>
            <span style="flex: 1 1 auto"></span>
            <button mat-raised-button color="primary" type="button" (click)="showAddItem = !showAddItem" [disabled]="!editable()">
              <mat-icon>add</mat-icon>
              Add item
            </button>
          </div>

          <form *ngIf="showAddItem" [formGroup]="itemSchemaForm" (ngSubmit)="addItem()" class="pt-grid" style="margin-top: 12px">
            <div *ngIf="!itemSchemaFields().length" class="pt-muted" style="grid-column: span 2">
              No template fields available.
            </div>
            <div *ngIf="itemSchemaFields().length" class="pt-field-block" style="grid-column: span 2">
              <div class="pt-row pt-field-head">
                <div class="pt-h">Template fields</div>
                <span class="pt-muted">From the selected template</span>
              </div>
              <div class="pt-field-list">
                <div class="pt-field-row" *ngFor="let field of itemSchemaFields()">
                  <ng-container *ngIf="schemaControl(field) as ctrl">
                    <mat-form-field appearance="outline" style="flex: 1 1 220px">
                      <mat-label>{{ field.label }}</mat-label>
                      <mat-select *ngIf="fieldType(field) === 'select'" [formControl]="ctrl">
                        <mat-option *ngFor="let opt of field.options || []" [value]="opt">{{ opt }}</mat-option>
                      </mat-select>
                      <mat-select *ngIf="fieldType(field) === 'boolean'" [formControl]="ctrl">
                        <mat-option [value]="true">Yes</mat-option>
                        <mat-option [value]="false">No</mat-option>
                      </mat-select>
                      <textarea *ngIf="fieldType(field) === 'textarea'" matInput rows="2" [formControl]="ctrl"></textarea>
                      <input *ngIf="fieldType(field) === 'number'" matInput type="number" [formControl]="ctrl" />
                      <input *ngIf="fieldType(field) === 'date'" matInput type="date" [formControl]="ctrl" />
                      <input
                        *ngIf="fieldType(field) === 'url' || fieldType(field) === 'text'"
                        matInput
                        type="text"
                        [formControl]="ctrl"
                      />
                      <input
                        *ngIf="fieldType(field) !== 'select' && fieldType(field) !== 'boolean' && fieldType(field) !== 'textarea' && fieldType(field) !== 'number' && fieldType(field) !== 'date' && fieldType(field) !== 'url' && fieldType(field) !== 'text'"
                        matInput
                        type="text"
                        [formControl]="ctrl"
                      />
                    </mat-form-field>
                  </ng-container>
                </div>
              </div>
            </div>

            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-raised-button color="primary" type="submit" [disabled]="itemSchemaForm.invalid || savingItem">
                <mat-icon>add</mat-icon>
                Add
              </button>
              <button mat-button type="button" (click)="showAddItem = false">Cancel</button>
            </div>
          </form>

          <table mat-table [dataSource]="bom()!.items" class="pt-table" style="margin-top: 14px">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let i">
                <div class="pt-title">{{ i.name }}</div>
                <div class="pt-muted" *ngIf="i.vendor">{{ i.vendor }}</div>
                <div class="pt-muted" *ngIf="i.category">{{ i.category }}</div>
              </td>
            </ng-container>
            <ng-container matColumnDef="qty">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let i">{{ i.quantity }} {{ i.unit }}</td>
            </ng-container>
            <ng-container matColumnDef="signoff">
              <th mat-header-cell *matHeaderCellDef>Signoff</th>
              <td mat-cell *matCellDef="let i">
                <div class="pt-row pt-signoff-cell">
                  <mat-chip>{{ i.signoff_status }}</mat-chip>
                  <button
                    mat-icon-button
                    color="primary"
                    type="button"
                    matTooltip="Request signoff"
                    (click)="openSignoffDialog(i)"
                    [disabled]="!canRequestWorkflow() || savingSignoff"
                  >
                    <mat-icon>task_alt</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="received">
              <th mat-header-cell *matHeaderCellDef>Received</th>
              <td mat-cell *matCellDef="let i">{{ i.received_quantity }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="itemColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: itemColumns"></tr>
          </table>
        </div>

        <div class="pt-section" data-tutorial="bom-workflow">
          <div class="pt-row" style="align-items:center; gap: 10px; flex-wrap: wrap">
            <div class="pt-h">Workflow</div>
            <span class="pt-muted">Owner or collaborator can request approvals.</span>
            <span style="flex: 1 1 auto"></span>
            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="openApprovalDialog()"
              [disabled]="!canRequestWorkflow() || savingApproval"
            >
              Request for approval
            </button>
          </div>

          <div class="pt-grid" style="margin-top: 18px">
            <mat-form-field appearance="outline" style="grid-column: span 2">
              <mat-label>Cancel comment (optional)</mat-label>
              <textarea matInput [formControl]="cancelForm.controls.comment" rows="2" [disabled]="!canCancelFlow()"></textarea>
            </mat-form-field>
            <div class="pt-row" style="gap: 10px; align-items:center; grid-column: span 2; flex-wrap: wrap">
              <button mat-stroked-button color="primary" type="button" (click)="cancelFlow()" [disabled]="!canCancelFlow() || savingCancel">
                Cancel workflow
              </button>
              <span class="pt-muted">Owner or procurement can cancel.</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-menu #downloadMenu="matMenu">
      <button mat-menu-item type="button" (click)="download('pdf')">PDF</button>
      <button mat-menu-item type="button" (click)="download('csv')">CSV</button>
      <button mat-menu-item type="button" (click)="download('json')">JSON</button>
    </mat-menu>

    <ng-template #loadingTpl>
      <mat-card>
        <mat-card-content>
          <div class="pt-row" style="gap:12px; align-items:center">
            
            <span>No data available</span>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-template>
  

    <div class="pt-page" *ngIf="order() as po">
      <div class="pt-header">
        <div>
          <div class="pt-title" data-tutorial="purchase-order-detail">Purchase Order {{ po.po_number || ('#' + po.id) }}</div>
          <div class="pt-muted">Status: {{ po.status }} ? Updated {{ po.updated_at | date: 'short' }}</div>
        </div>
        <div class="pt-actions">
          <button mat-stroked-button color="primary" routerLink="/purchase-orders">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary" type="button" (click)="markSent()" [disabled]="!isProcurement()">
            Mark sent
          </button>
          <button mat-button color="primary" type="button" (click)="cancelOrder()" [disabled]="!isProcurement()">
            Cancel
          </button>
        </div>
      </div>

      <div class="pt-grid">
        <mat-card class="pt-panel">
          <mat-card-title>Order details</mat-card-title>
          <mat-card-content>
            <form class="pt-form" [formGroup]="detailForm" (ngSubmit)="saveDetails()">
              <mat-form-field appearance="outline">
                <input matInput placeholder="BOM ID" formControlName="bom" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="PO number" formControlName="po_number" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Vendor" formControlName="vendor_name" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Currency" formControlName="currency" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <textarea matInput rows="3" placeholder="Notes" formControlName="notes"></textarea>
              </mat-form-field>
              <button mat-raised-button color="primary" type="submit" [disabled]="!isProcurement()">Save</button>
            </form>
          </mat-card-content>
        </mat-card>

        <mat-card class="pt-panel">
          <mat-card-title>Add line item</mat-card-title>
          <mat-card-content>
            <div class="pt-muted" *ngIf="!isProcurement()">Procurement role required to add items.</div>
            <form class="pt-form" [formGroup]="addItemForm" (ngSubmit)="addItem()">
              <mat-form-field appearance="outline">
                <input matInput placeholder="BOM item ID" formControlName="bom_item" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Name" formControlName="name" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <textarea matInput rows="2" placeholder="Description" formControlName="description"></textarea>
              </mat-form-field>
              <div class="pt-grid-3">
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Quantity" formControlName="quantity" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Unit" formControlName="unit" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Currency" formControlName="currency" />
                </mat-form-field>
              </div>
              <div class="pt-grid-3">
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Unit price" formControlName="unit_price" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Tax %" formControlName="tax_percent" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <input matInput placeholder="ETA date" type="date" formControlName="eta_date" />
                </mat-form-field>
              </div>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Vendor" formControlName="vendor" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Category" formControlName="category" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <input matInput placeholder="Link" formControlName="link" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <textarea matInput rows="2" placeholder="Notes" formControlName="notes"></textarea>
              </mat-form-field>
              <button mat-raised-button color="primary" type="submit" [disabled]="!isProcurement() || addItemForm.invalid">Add item</button>
            </form>
          </mat-card-content>
        </mat-card>
      </div>

      <mat-card class="pt-panel">
        <mat-card-title>Line items</mat-card-title>
        <mat-card-content>
          <table mat-table [dataSource]="po.items" class="pt-table">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Item</th>
              <td mat-cell *matCellDef="let item">
                <div class="pt-strong">{{ item.name }}</div>
                <div class="pt-muted">{{ item.description || 'No description' }}</div>
                <div class="pt-muted" *ngIf="item.category">{{ item.category }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="qty">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let item">{{ item.quantity }} {{ item.unit }}</td>
            </ng-container>

            <ng-container matColumnDef="received">
              <th mat-header-cell *matHeaderCellDef>Received</th>
              <td mat-cell *matCellDef="let item">
                <div>{{ item.received_quantity }} {{ item.unit }}</div>
                <div class="pt-muted" *ngIf="item.received_at">{{ item.received_at | date: 'short' }}</div>
              </td>
            </ng-container>

            <ng-container matColumnDef="eta">
              <th mat-header-cell *matHeaderCellDef>ETA</th>
              <td mat-cell *matCellDef="let item">{{ item.eta_date || '?' }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let item">{{ itemStatus(item) }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <div *ngIf="po.items.length === 0" class="pt-muted">No data available</div>

          <div class="pt-receive" *ngIf="po.items.length">
            <div class="pt-receive-title">Record receipt</div>
            <div class="pt-receive-grid">
              <div class="pt-receive-row" *ngFor="let item of po.items">
                <div class="pt-strong">{{ item.name }}</div>
                <mat-form-field appearance="outline">
                  <input matInput placeholder="Qty received" [(ngModel)]="receiveMap[item.id]" [ngModelOptions]="{standalone: true}" />
                </mat-form-field>
              </div>
            </div>
            <button mat-raised-button color="primary" type="button" (click)="recordReceipt()" [disabled]="!isProcurement()">Save receipt</button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div *ngIf="loading()" class="pt-muted">No data available</div>
  
